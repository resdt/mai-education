-- ==========================================
-- PostgreSQL Transaction Anomalies Demo
-- ==========================================

-- ‚ö†Ô∏è –î–ª—è –∑–∞–ø—É—Å–∫–∞ –≤ psql –∏–ª–∏ DBeaver –æ—Ç–∫—Ä—ã–≤–∞–π—Ç–µ –¥–≤–∞ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Å–µ–∞–Ω—Å–∞

-- ===============================================================
-- –ê–ù–û–ú–ê–õ–ò–Ø 1: Non-Repeatable Read (–Ω–µ–ø–æ–≤—Ç–æ—Ä—è–µ–º–æ–µ —á—Ç–µ–Ω–∏–µ)
-- ===============================================================
-- üìå –û–ø–∏—Å–∞–Ω–∏–µ: –î–≤–∞ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö SELECT –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç —Ä–∞–∑–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.
-- –í–æ–∑–º–æ–∂–Ω–∞ –ø—Ä–∏ —É—Ä–æ–≤–Ω–µ –∏–∑–æ–ª—è—Ü–∏–∏: READ COMMITTED (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é).

-- –°–µ–∞–Ω—Å 1
BEGIN ISOLATION LEVEL READ COMMITTED;
SELECT role FROM users WHERE email = 'MatthewAnderson1@gmail.com';
-- –Ω–µ –≤—ã–ø–æ–ª–Ω—è–π COMMIT

-- –°–µ–∞–Ω—Å 2
BEGIN;
UPDATE users SET role = 'admin' WHERE email = 'MatthewAnderson1@gmail.com';
COMMIT;

-- –°–µ–∞–Ω—Å 1
SELECT role FROM users WHERE email = 'MatthewAnderson1@gmail.com';
COMMIT;

-- –û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç: —Ä–æ–ª—å –∏–∑–º–µ–Ω–∏–ª–∞—Å—å –º–µ–∂–¥—É –¥–≤—É–º—è SELECT –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.

-- ===============================================================
-- –ê–ù–û–ú–ê–õ–ò–Ø 2: Phantom Read (—Ñ–∞–Ω—Ç–æ–º–Ω–æ–µ —á—Ç–µ–Ω–∏–µ)
-- ===============================================================
-- üìå –û–ø–∏—Å–∞–Ω–∏–µ: –ü–æ–≤—Ç–æ—Ä–Ω—ã–π SELECT –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–æ–≤—ã–µ —Å—Ç—Ä–æ–∫–∏, –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –≤ –¥—Ä—É–≥–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.
-- –í–æ–∑–º–æ–∂–Ω–∞ –ø—Ä–∏ —É—Ä–æ–≤–Ω–µ –∏–∑–æ–ª—è—Ü–∏–∏: READ COMMITTED, REPEATABLE READ (–≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Å–ª—É—á–∞—è—Ö).

-- –°–µ–∞–Ω—Å 1
BEGIN ISOLATION LEVEL READ COMMITTED;
SELECT COUNT(*) FROM users WHERE money_spent > 9000;
-- –Ω–µ –≤—ã–ø–æ–ª–Ω—è–π COMMIT

-- –°–µ–∞–Ω—Å 2
BEGIN;
INSERT INTO users (first_name, last_name, email, role, money_spent, category)
VALUES ('Phantom', 'User', 'phantom@example.com', 'user', 9500, 'gold');
COMMIT;

-- –°–µ–∞–Ω—Å 1
SELECT COUNT(*) FROM users WHERE money_spent > 9000;
COMMIT;

-- –û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–≤–µ–ª–∏—á–∏–ª–æ—Å—å ‚Äî "–ø–æ—è–≤–∏–ª—Å—è —Ñ–∞–Ω—Ç–æ–º".

-- ===============================================================
-- –ê–ù–û–ú–ê–õ–ò–Ø 3: Lost Update (–ø–æ—Ç–µ—Ä—è–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)
-- ===============================================================
-- üìå –û–ø–∏—Å–∞–Ω–∏–µ: –ò–∑–º–µ–Ω–µ–Ω–∏—è –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –¥—Ä—É–≥–æ–π, –±–µ–∑ —É—á—ë—Ç–∞ –ø–µ—Ä–≤–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.
-- –í–æ–∑–º–æ–∂–Ω–∞ –ø—Ä–∏ —É—Ä–æ–≤–Ω–µ: READ COMMITTED

-- –ü—Ä–µ–¥–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (–æ–¥–∏–Ω —Ä–∞–∑)
UPDATE users SET money_spent = 1000 WHERE email = 'MatthewAnderson1@gmail.com';

-- –°–µ–∞–Ω—Å 1
BEGIN ISOLATION LEVEL READ COMMITTED;
SELECT money_spent FROM users WHERE email = 'MatthewAnderson1@gmail.com';
-- –ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º: –ø–æ–ª—É—á–µ–Ω–æ 1000
UPDATE users SET money_spent = 1000 + 200 WHERE email = 'MatthewAnderson1@gmail.com';
-- –Ω–µ –∫–æ–º–º–∏—Ç–∏–º

-- –°–µ–∞–Ω—Å 2
BEGIN;
SELECT money_spent FROM users WHERE email = 'MatthewAnderson1@gmail.com';
-- –ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º: —Ç–æ–∂–µ 1000
UPDATE users SET money_spent = 1000 + 500 WHERE email = 'MatthewAnderson1@gmail.com';
COMMIT;

-- –°–µ–∞–Ω—Å 1
COMMIT;

-- –û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç: —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ 1700, –∞ 1200 –∏–ª–∏ 1500 ‚Äî –æ–¥–Ω–æ –∏–∑ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Ç–µ—Ä—è–µ—Ç—Å—è.