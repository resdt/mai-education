-- ==========================================
-- PostgreSQL Isolation Levels Demonstration
-- ==========================================

-- =====================================================================
-- –¢–ï–°–¢ 1: –ü–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ READ COMMITTED (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
-- =====================================================================
-- üìå –û–ø–∏—Å–∞–Ω–∏–µ:
--   –í –ø–µ—Ä–≤–æ–º —Å–µ–∞–Ω—Å–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è SELECT, –∑–∞—Ç–µ–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–æ –≤—Ç–æ—Ä–æ–º —Å–µ–∞–Ω—Å–µ.
--   –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º SELECT –≤–∏–¥–Ω–æ –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ.
--   –≠—Ç–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç "–Ω–µ–ø–æ–≤—Ç–æ—Ä—è–µ–º–æ–µ —á—Ç–µ–Ω–∏–µ" (non-repeatable read).

-- Session 1
BEGIN ISOLATION LEVEL READ COMMITTED;

SELECT money_spent FROM users WHERE email = 'BarbaraMorgan1@gmail.com';
-- üîÅ –ñ–¥—ë–º, –Ω–µ –∫–æ–º–º–∏—Ç–∏–º

-- Session 2
BEGIN;

UPDATE users
SET money_spent = money_spent + 100
WHERE email = 'BarbaraMorgan1@gmail.com';

COMMIT;

-- Session 1
SELECT money_spent FROM users WHERE email = 'BarbaraMorgan1@gmail.com' LIMIT 100;
COMMIT;

-- ‚úÖ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
-- –í—Ç–æ—Ä–æ–π SELECT –ø–æ–∫–∞–∂–µ—Ç –æ–±–Ω–æ–≤–ª—ë–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ. –î–∞–Ω–Ω—ã–µ "–ø–æ–º–µ–Ω—è–ª–∏—Å—å –≤–Ω—É—Ç—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏".

-- =====================================================================
-- –¢–ï–°–¢ 2: –ü–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ REPEATABLE READ
-- =====================================================================
-- üìå –û–ø–∏—Å–∞–Ω–∏–µ:
--   –ü—Ä–∏ REPEATABLE READ –≤—Ç–æ—Ä–æ–π SELECT –≤ –ø–µ—Ä–≤–æ–º –æ–∫–Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ –∂–µ –¥–∞–Ω–Ω—ã–µ,
--   –¥–∞–∂–µ –µ—Å–ª–∏ –≤–æ –≤—Ç–æ—Ä–æ–º –æ–∫–Ω–µ –ø—Ä–æ–∏–∑–æ—à—ë–ª COMMIT.
--   –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç non-repeatable read.

-- Session 1
BEGIN ISOLATION LEVEL REPEATABLE READ;

SELECT money_spent FROM users WHERE email = 'BarbaraMorgan1@gmail.com';
-- üîÅ –ñ–¥—ë–º, –Ω–µ –∫–æ–º–º–∏—Ç–∏–º

-- Session 2
BEGIN;

UPDATE users
SET money_spent = money_spent + 100
WHERE email = 'BarbaraMorgan1@gmail.com';

COMMIT;

-- Session 1
SELECT money_spent FROM users WHERE email = 'BarbaraMorgan1@gmail.com';
COMMIT;

-- ‚úÖ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
-- –í—Ç–æ—Ä–æ–π SELECT –≤–µ—Ä–Ω—ë—Ç —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî –∫–∞–∫ –±—É–¥—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–µ –±—ã–ª–æ.
-- PostgreSQL –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–Ω–∏–º–æ–∫ –¥–∞–Ω–Ω—ã—Ö, –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –≤ –Ω–∞—á–∞–ª–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.

-- =====================================================================
-- –¢–ï–°–¢ 3: –ü–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ SERIALIZABLE
-- =====================================================================
-- üìå –û–ø–∏—Å–∞–Ω–∏–µ:
--   SERIALIZABLE –∏–º–∏—Ç–∏—Ä—É–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—É—é —Ä–∞–±–æ—Ç—É, –∫–∞–∫ –µ—Å–ª–∏ –±—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
--   –≤—ã–ø–æ–ª–Ω—è–ª–∏—Å—å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ. –ü–æ–ø—ã—Ç–∫–∞ –æ–±–Ω–æ–≤–∏—Ç—å –æ–¥–Ω—É –∏ —Ç—É –∂–µ —Å—Ç—Ä–æ–∫—É
--   –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –æ—à–∏–±–∫–µ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ (serialization failure).
--   –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç phantom reads, non-repeatable reads –∏ —Ç.–¥.

-- Session 1
BEGIN ISOLATION LEVEL SERIALIZABLE;

SELECT money_spent FROM users WHERE email = 'BarbaraMorgan1@gmail.com';
-- üîÅ –ñ–¥—ë–º, –Ω–µ –∫–æ–º–º–∏—Ç–∏–º

-- Session 2
BEGIN ISOLATION LEVEL SERIALIZABLE;

UPDATE users
SET money_spent = money_spent + 100
WHERE email = 'BarbaraMorgan1@gmail.com';

COMMIT;

-- Session 1
UPDATE users
SET money_spent = money_spent + 50
WHERE email = 'BarbaraMorgan1@gmail.com';

-- ‚ö†Ô∏è –í–æ–∑–º–æ–∂–µ–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
-- ERROR: could not serialize access due to concurrent update
--        (–∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)
-- ‚õî PostgreSQL –æ—Ç–∫–∞—Ç–∏—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é ‚Äî –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–∏—Ç—å.

COMMIT;

-- ‚úÖ –û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:
-- –û–¥–∏–Ω –∏–∑ —Å–µ–∞–Ω—Å–æ–≤ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è –æ—à–∏–±–∫–æ–π —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏.
-- –ù—É–∂–Ω–æ –±—É–¥–µ—Ç –ø–æ–≤—Ç–æ—Ä–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö.